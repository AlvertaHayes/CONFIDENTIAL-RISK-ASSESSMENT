<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidential Risk Assessment Platform</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üîí</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #0f172a 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(circle at 20% 30%, rgba(236, 72, 153, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(168, 85, 247, 0.1) 0%, transparent 50%);
            animation: gradientShift 20s ease infinite;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(5%, 5%) rotate(120deg); }
            66% { transform: translate(-5%, 5%) rotate(240deg); }
        }

        .container {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow:
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: visible;
            max-width: 1200px;
            width: 100%;
            min-height: 600px;
            position: relative;
            z-index: 1;
            margin: 20px 0;
        }

        .header {
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 50%, #3b82f6 100%);
            color: white;
            padding: 35px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 12px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.15rem;
            opacity: 0.95;
        }

        .main-content {
            padding: 40px;
        }

        .connection-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .connect-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 28px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .connect-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(16, 185, 129, 0.4);
        }

        .connect-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-section {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 28px;
            margin: 20px 0;
            border: 1px solid rgba(236, 72, 153, 0.3);
        }

        .status-section h2 {
            color: #f1f5f9;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .status-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 22px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(168, 85, 247, 0.3);
            transition: all 0.3s ease;
        }

        .status-card:hover {
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.4);
            transform: translateY(-2px);
            border-color: rgba(236, 72, 153, 0.6);
        }

        .status-card h3 {
            color: #cbd5e1;
            margin-bottom: 12px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .status-card .value {
            font-size: 1.6rem;
            font-weight: bold;
            background: linear-gradient(135deg, #ec4899, #a855f7, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .actions-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .action-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 16px;
            padding: 28px;
            transition: all 0.3s ease;
        }

        .action-card:hover {
            border-color: rgba(236, 72, 153, 0.6);
            transform: translateY(-5px);
            box-shadow: 0 16px 35px rgba(236, 72, 153, 0.3);
        }

        .action-card h3 {
            color: #f1f5f9;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .action-card p {
            color: #cbd5e1 !important;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input {
            width: 100%;
            padding: 13px 16px;
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(15, 23, 42, 0.6);
            color: #f1f5f9;
        }

        .form-group input::placeholder {
            color: #64748b;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
        }

        .submit-btn {
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.6);
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .owner-section {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: white;
            border-radius: 16px;
            padding: 28px;
            margin-top: 20px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
            font-weight: 500;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: #ef4444;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .business-hours {
            background: rgba(16, 185, 129, 0.15);
            border-left: 5px solid #10b981;
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
            color: #d1fae5;
        }

        .business-hours.closed {
            background: rgba(239, 68, 68, 0.15);
            border-left-color: #ef4444;
            color: #fecaca;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 20px;
            }

            .actions-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Confidential Risk Assessment</h1>
            <p>Privacy-Preserving Financial Risk Evaluation using Fully Homomorphic Encryption</p>
        </div>

        <div class="main-content">
            <!-- Connection Section -->
            <div class="connection-section">
                <button id="connectBtn" class="connect-btn">Connect Wallet</button>
                <div id="accountInfo" style="display: none; margin-top: 15px;">
                    <p style="margin: 8px 0; color: #cbd5e1; font-weight: 500;"><strong>Connected:</strong> <span id="accountAddress"></span></p>
                    <p style="margin: 8px 0; color: #cbd5e1; font-weight: 500;"><strong>Network:</strong> <span id="networkName"></span></p>
                    <p style="margin: 8px 0; color: #cbd5e1; font-weight: 500;"><strong>Contract:</strong> <span id="contractAddressDisplay"></span></p>
                </div>
            </div>

            <!-- Status Section -->
            <div class="status-section">
                <h2 style="margin-bottom: 10px; color: #f1f5f9;">üìä Assessment Status</h2>
                <div id="businessHours" class="business-hours">
                    <strong>‚è∞ Business Hours Status:</strong> <span id="hoursStatus">Checking...</span>
                </div>
                <div style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 12px; margin: 12px 0; color: #93c5fd; font-size: 0.9rem;">
                    <strong>üìÖ Current UTC Time:</strong> <span id="utcTime">--:--:--</span> |
                    <strong>Allowed Times:</strong> Start Assessment (9-17 UTC) | Process Assessment (17-24 & 0-9 UTC)
                </div>
                <div class="status-grid">
                    <div class="status-card">
                        <h3>Current Assessment ID</h3>
                        <div class="value" id="assessmentId">-</div>
                    </div>
                    <div class="status-card">
                        <h3>Assessment Status</h3>
                        <div class="value" id="assessmentStatus">-</div>
                    </div>
                    <div class="status-card">
                        <h3>Applicants Count</h3>
                        <div class="value" id="applicantCount">-</div>
                    </div>
                    <div class="status-card">
                        <h3>Current Time (UTC)</h3>
                        <div class="value" id="currentTime" style="font-size: 1.2rem;">-</div>
                    </div>
                </div>
            </div>

            <!-- Assessment Window Alert -->
            <div id="assessmentAlert" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 12px; padding: 16px; margin: 20px 0; color: #fecaca;">
                <strong>‚ö†Ô∏è Assessment Window Not Active</strong>
                <p style="margin-top: 8px; color: #fca5a5;">The contract owner must start a new assessment during business hours (9-17 UTC) before you can submit your risk profile.</p>
            </div>

            <!-- Actions Section -->
            <div class="actions-section">
                <!-- Submit Risk Profile -->
                <div class="action-card">
                    <h3>üìù Submit Risk Profile</h3>
                    <p style="margin-bottom: 24px; color: #6b7280; line-height: 1.6;">Submit your confidential financial information for risk assessment. All data is encrypted on-chain.</p>

                    <div class="form-group">
                        <label for="creditScore">Credit Score (300-850)</label>
                        <input type="number" id="creditScore" min="300" max="850" placeholder="750">
                    </div>

                    <div class="form-group">
                        <label for="income">Annual Income (USD)</label>
                        <input type="number" id="income" min="0" placeholder="75000">
                    </div>

                    <div class="form-group">
                        <label for="employmentYears">Employment Years</label>
                        <input type="number" id="employmentYears" min="0" max="50" placeholder="5">
                    </div>

                    <div class="form-group">
                        <label for="debtRatio">Debt Ratio (0-100%)</label>
                        <input type="number" id="debtRatio" min="0" max="100" placeholder="25">
                    </div>

                    <button id="submitProfileBtn" class="submit-btn">Submit Profile</button>
                </div>

                <!-- Check Status -->
                <div class="action-card">
                    <h3>üîç Check Your Status</h3>
                    <p style="margin-bottom: 24px; color: #6b7280; line-height: 1.6;">Check your application status and approval results.</p>

                    <div id="applicantStatus" style="margin-bottom: 20px;">
                        <div class="status-card">
                            <h3>Profile Submitted</h3>
                            <div class="value" id="profileSubmitted">-</div>
                        </div>
                        <div class="status-card" style="margin-top: 12px;">
                            <h3>Approval Status</h3>
                            <div class="value" id="approvalStatus">-</div>
                        </div>
                    </div>

                    <button id="checkStatusBtn" class="submit-btn">Refresh Status</button>
                </div>
            </div>

            <!-- Owner Section -->
            <div id="ownerSection" class="owner-section" style="display: none;">
                <h3 style="margin-bottom: 8px; font-size: 1.5rem;">‚öôÔ∏è Owner Controls</h3>
                <p style="margin-bottom: 12px; opacity: 0.95;">Administrative functions for assessment management.</p>
                <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 0.9rem;">
                    <strong>‚ÑπÔ∏è Instructions:</strong>
                    <ol style="margin: 8px 0 0 20px; opacity: 0.9; line-height: 1.6;">
                        <li>Click "Start New Assessment" during business hours (9-17 UTC) to activate the assessment window</li>
                        <li>Users can submit risk profiles while the window is active</li>
                        <li>Click "Process Assessment" after business hours to evaluate submissions</li>
                        <li>Use "Pause Assessment" in emergency situations only</li>
                    </ol>
                </div>

                <button id="startAssessmentBtn" class="connect-btn" style="margin-right: 10px; margin-bottom: 10px;">Start New Assessment</button>
                <button id="processAssessmentBtn" class="connect-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); margin-right: 10px; margin-bottom: 10px;">Process Assessment</button>
                <button id="pauseAssessmentBtn" class="connect-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); margin-bottom: 10px;">Pause Assessment</button>
            </div>

            <!-- Assessment History -->
            <div class="action-card" style="margin-top: 30px;">
                <h3>üìö Assessment History</h3>
                <p style="margin-bottom: 24px; color: #6b7280; line-height: 1.6;">View completed risk assessments.</p>

                <div class="form-group">
                    <label for="historyId">Assessment ID</label>
                    <input type="number" id="historyId" min="1" placeholder="1">
                </div>

                <button id="viewHistoryBtn" class="submit-btn">View History</button>

                <div id="historyResult" style="margin-top: 24px; display: none;">
                    <div class="status-grid">
                        <div class="status-card">
                            <h3>Completed</h3>
                            <div class="value" id="historyCompleted">-</div>
                        </div>
                        <div class="status-card">
                            <h3>Risk Level</h3>
                            <div class="value" id="historyRiskLevel">-</div>
                        </div>
                        <div class="status-card">
                            <h3>Applicants</h3>
                            <div class="value" id="historyApplicants">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0xb31466614577173Ac92ADbc6eDC2884114dcB2BF';
        const CONTRACT_ABI = [
            "function owner() public view returns (address)",
            "function currentAssessmentId() public view returns (uint32)",
            "function isBusinessHours() public view returns (bool)",
            "function isAssessmentWindowActive() public view returns (bool)",
            "function isEvaluationTimeActive() public view returns (bool)",
            "function getCurrentHour() public view returns (uint256)",
            "function startNewAssessment() external",
            "function submitRiskProfile(uint16 _creditScore, uint32 _income, uint8 _employmentYears, uint16 _debtRatio) external",
            "function processRiskAssessment() external",
            "function pauseCurrentAssessment() external",
            "function getCurrentAssessmentInfo() external view returns (uint32 assessmentId, bool thresholdSet, bool assessmentCompleted, uint256 startTime, uint256 applicantCount)",
            "function getApplicantStatus(address applicant) external view returns (bool hasSubmitted, uint256 timestamp, bool isApproved)",
            "function getAssessmentHistory(uint32 assessmentId) external view returns (bool assessmentCompleted, uint8 finalRiskLevel, uint256 startTime, uint256 endTime, uint256 applicantCount)",
            "function checkApprovalStatus(uint32 assessmentId, address applicant) external view returns (bool)",
            "event AssessmentStarted(uint32 indexed assessmentId, uint256 startTime)",
            "event ProfileSubmitted(address indexed applicant, uint32 indexed assessmentId)",
            "event AssessmentCompleted(uint32 indexed assessmentId, uint256 approvedCount)",
            "event RiskLevelRevealed(uint32 indexed assessmentId, uint8 riskThreshold)"
        ];

        // Global variables
        let provider;
        let signer;
        let contract;
        let userAccount;
        let isOwner = false;

        // Initialize the application
        window.addEventListener('load', async () => {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // Check if ethers is loaded
            if (typeof ethers === 'undefined') {
                showNotification('Failed to load ethers.js library. Please refresh the page.', 'error');
                return;
            }

            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask detected');
                setupEventListeners();

                // Check if already connected
                const accounts = await window.ethereum.request({method: 'eth_accounts'});
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } else {
                showNotification('Please install MetaMask to use this application', 'error');
            }
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('submitProfileBtn').addEventListener('click', submitRiskProfile);
            document.getElementById('checkStatusBtn').addEventListener('click', checkApplicantStatus);
            document.getElementById('startAssessmentBtn').addEventListener('click', startNewAssessment);
            document.getElementById('processAssessmentBtn').addEventListener('click', processAssessment);
            document.getElementById('pauseAssessmentBtn').addEventListener('click', pauseAssessment);
            document.getElementById('viewHistoryBtn').addEventListener('click', viewAssessmentHistory);
        }

        // Initialize contract
        async function initializeContract() {
            try {
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                await checkOwnerStatus();
                await updateAssessmentInfo();
                await updateBusinessHours();
                showNotification('Contract connected successfully!', 'success');
            } catch (error) {
                console.error('Error initializing contract:', error);
                showNotification('Failed to connect to contract: ' + error.message, 'error');
            }
        }

        // Connect wallet
        async function connectWallet() {
            try {
                await window.ethereum.request({method: 'eth_requestAccounts'});
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAccount = await signer.getAddress();

                // Check network
                const network = await provider.getNetwork();
                document.getElementById('networkName').textContent = network.name;

                // Update UI
                document.getElementById('connectBtn').textContent = 'Connected';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('accountInfo').style.display = 'block';
                document.getElementById('accountAddress').textContent =
                    userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                document.getElementById('contractAddressDisplay').textContent =
                    CONTRACT_ADDRESS.substring(0, 6) + '...' + CONTRACT_ADDRESS.substring(38);

                // Initialize contract
                await initializeContract();

                showNotification('Wallet connected successfully!', 'success');
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showNotification('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        // Check if current user is owner
        async function checkOwnerStatus() {
            try {
                const owner = await contract.owner();
                isOwner = owner.toLowerCase() === userAccount.toLowerCase();

                if (isOwner) {
                    document.getElementById('ownerSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking owner status:', error);
            }
        }

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toUTCString().substring(17, 25);
            document.getElementById('currentTime').textContent = timeStr;

            // Update UTC time display
            const utcTimeElement = document.getElementById('utcTime');
            if (utcTimeElement) {
                const hour = now.getUTCHours();
                utcTimeElement.textContent = `${timeStr} (Hour: ${hour})`;
            }
        }

        // Update business hours status
        async function updateBusinessHours() {
            try {
                const isBusinessHours = await contract.isBusinessHours();
                const currentHour = await contract.getCurrentHour();
                const hoursElement = document.getElementById('businessHours');
                const statusElement = document.getElementById('hoursStatus');

                if (isBusinessHours) {
                    hoursElement.classList.remove('closed');
                    statusElement.textContent = `Open (Current hour: ${currentHour} UTC)`;
                } else {
                    hoursElement.classList.add('closed');
                    statusElement.textContent = `Closed (Current hour: ${currentHour} UTC) - Business hours: 9-17 UTC`;
                }
            } catch (error) {
                console.error('Error updating business hours:', error);
            }
        }

        // Update assessment information
        async function updateAssessmentInfo() {
            try {
                const info = await contract.getCurrentAssessmentInfo();

                document.getElementById('assessmentId').textContent = info.assessmentId.toString();
                document.getElementById('applicantCount').textContent = info.applicantCount.toString();

                let status = 'Not Started';
                let isActive = false;
                if (info.thresholdSet && !info.assessmentCompleted) {
                    status = 'Active';
                    isActive = true;
                } else if (info.assessmentCompleted) {
                    status = 'Completed';
                }
                document.getElementById('assessmentStatus').textContent = status;

                // Show/hide assessment alert
                const alertElement = document.getElementById('assessmentAlert');
                if (alertElement) {
                    if (!isActive) {
                        alertElement.style.display = 'block';
                    } else {
                        alertElement.style.display = 'none';
                    }
                }

                // Check applicant status
                await checkApplicantStatus();
            } catch (error) {
                console.error('Error updating assessment info:', error);
            }
        }

        // Submit risk profile
        async function submitRiskProfile() {
            if (!contract) {
                showNotification('Please connect wallet first', 'error');
                return;
            }

            // Check if assessment window is active
            try {
                const isWindowActive = await contract.isAssessmentWindowActive();
                if (!isWindowActive) {
                    showNotification('Assessment window is not active. Owner must start a new assessment during business hours (9-17 UTC).', 'error');
                    return;
                }
            } catch (error) {
                console.error('Error checking assessment window:', error);
            }

            const creditScore = document.getElementById('creditScore').value;
            const income = document.getElementById('income').value;
            const employmentYears = document.getElementById('employmentYears').value;
            const debtRatio = document.getElementById('debtRatio').value;

            if (!creditScore || !income || !employmentYears || !debtRatio) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (creditScore < 300 || creditScore > 850) {
                showNotification('Credit score must be between 300 and 850', 'error');
                return;
            }

            if (employmentYears > 50) {
                showNotification('Employment years cannot exceed 50', 'error');
                return;
            }

            if (debtRatio > 100) {
                showNotification('Debt ratio cannot exceed 100%', 'error');
                return;
            }

            try {
                const btn = document.getElementById('submitProfileBtn');
                btn.innerHTML = '<div class="loading"></div>Submitting...';
                btn.disabled = true;

                const tx = await contract.submitRiskProfile(
                    parseInt(creditScore),
                    parseInt(income),
                    parseInt(employmentYears),
                    parseInt(debtRatio)
                );

                showNotification('Transaction submitted! Waiting for confirmation...', 'success');
                await tx.wait();

                showNotification('Risk profile submitted successfully!', 'success');
                await updateAssessmentInfo();

                // Clear form
                document.getElementById('creditScore').value = '';
                document.getElementById('income').value = '';
                document.getElementById('employmentYears').value = '';
                document.getElementById('debtRatio').value = '';

            } catch (error) {
                console.error('Error submitting profile:', error);
                let errorMsg = 'Failed to submit profile';
                if (error.message.includes('Assessment window not active')) {
                    errorMsg = 'Assessment window is not active. Wait for owner to start assessment.';
                } else if (error.message.includes('Profile already submitted')) {
                    errorMsg = 'You have already submitted a profile for this assessment.';
                } else if (error.message.includes('Not during business hours')) {
                    errorMsg = 'Submissions only allowed during business hours (9-17 UTC).';
                } else if (error.message) {
                    errorMsg = error.message.split('(')[0].trim();
                }
                showNotification(errorMsg, 'error');
            } finally {
                const btn = document.getElementById('submitProfileBtn');
                btn.innerHTML = 'Submit Profile';
                btn.disabled = false;
            }
        }

        // Check applicant status
        async function checkApplicantStatus() {
            if (!contract || !userAccount) return;

            try {
                const status = await contract.getApplicantStatus(userAccount);

                document.getElementById('profileSubmitted').textContent = status.hasSubmitted ? 'Yes' : 'No';
                document.getElementById('approvalStatus').textContent = status.isApproved ? 'Approved' : 'Pending';

            } catch (error) {
                console.error('Error checking applicant status:', error);
            }
        }

        // Start new assessment (owner only)
        async function startNewAssessment() {
            if (!contract || !isOwner) return;

            try {
                // Check business hours first
                const isBusinessHours = await contract.isBusinessHours();
                const currentHour = await contract.getCurrentHour();

                if (!isBusinessHours) {
                    showNotification(`Cannot start assessment outside business hours. Current UTC hour: ${currentHour}. Business hours: 9-17 UTC.`, 'error');
                    return;
                }

                const btn = document.getElementById('startAssessmentBtn');
                btn.innerHTML = '<div class="loading"></div>Starting...';
                btn.disabled = true;

                const tx = await contract.startNewAssessment();
                showNotification('Transaction submitted! Waiting for confirmation...', 'success');
                await tx.wait();

                showNotification('New assessment started successfully!', 'success');
                await updateAssessmentInfo();

            } catch (error) {
                console.error('Error starting assessment:', error);
                let errorMsg = 'Failed to start assessment';
                if (error.message.includes('Not during business hours')) {
                    errorMsg = 'Can only start assessment during business hours (9-17 UTC)';
                } else if (error.message.includes('Assessment already active')) {
                    errorMsg = 'An assessment is already active. Complete it first.';
                } else if (error.message) {
                    errorMsg = error.message.split('(')[0].trim();
                }
                showNotification(errorMsg, 'error');
            } finally {
                const btn = document.getElementById('startAssessmentBtn');
                btn.innerHTML = 'Start New Assessment';
                btn.disabled = false;
            }
        }

        // Process assessment (owner only)
        async function processAssessment() {
            if (!contract || !isOwner) return;

            try {
                // Check evaluation time
                const isEvaluationTime = await contract.isEvaluationTimeActive();
                const currentHour = await contract.getCurrentHour();

                if (!isEvaluationTime) {
                    showNotification(`Can only process assessment after business hours. Current UTC hour: ${currentHour}. Process after 17 UTC.`, 'error');
                    return;
                }

                const btn = document.getElementById('processAssessmentBtn');
                btn.innerHTML = '<div class="loading"></div>Processing...';
                btn.disabled = true;

                const tx = await contract.processRiskAssessment();
                showNotification('Transaction submitted! Waiting for confirmation...', 'success');
                await tx.wait();

                showNotification('Assessment processing initiated!', 'success');
                await updateAssessmentInfo();

            } catch (error) {
                console.error('Error processing assessment:', error);
                let errorMsg = 'Failed to process assessment';
                if (error.message.includes('Not evaluation time')) {
                    errorMsg = 'Can only process assessment after business hours (after 17 UTC)';
                } else if (error.message.includes('No threshold set')) {
                    errorMsg = 'No assessment has been started yet';
                } else if (error.message.includes('Assessment already completed')) {
                    errorMsg = 'This assessment has already been completed';
                } else if (error.message) {
                    errorMsg = error.message.split('(')[0].trim();
                }
                showNotification(errorMsg, 'error');
            } finally {
                const btn = document.getElementById('processAssessmentBtn');
                btn.innerHTML = 'Process Assessment';
                btn.disabled = false;
            }
        }

        // Pause assessment (owner only)
        async function pauseAssessment() {
            if (!contract || !isOwner) return;

            try {
                const btn = document.getElementById('pauseAssessmentBtn');
                btn.innerHTML = '<div class="loading"></div>Pausing...';
                btn.disabled = true;

                const tx = await contract.pauseCurrentAssessment();
                showNotification('Transaction submitted! Waiting for confirmation...', 'success');
                await tx.wait();

                showNotification('Assessment paused successfully!', 'success');
                await updateAssessmentInfo();

            } catch (error) {
                console.error('Error pausing assessment:', error);
                showNotification('Failed to pause assessment: ' + error.message, 'error');
            } finally {
                const btn = document.getElementById('pauseAssessmentBtn');
                btn.innerHTML = 'Pause Assessment';
                btn.disabled = false;
            }
        }

        // View assessment history
        async function viewAssessmentHistory() {
            if (!contract) return;

            const historyId = document.getElementById('historyId').value;
            if (!historyId) {
                showNotification('Please enter an assessment ID', 'error');
                return;
            }

            try {
                const btn = document.getElementById('viewHistoryBtn');
                btn.innerHTML = '<div class="loading"></div>Loading...';
                btn.disabled = true;

                const history = await contract.getAssessmentHistory(parseInt(historyId));

                document.getElementById('historyCompleted').textContent = history.assessmentCompleted ? 'Yes' : 'No';
                document.getElementById('historyRiskLevel').textContent = history.finalRiskLevel.toString();
                document.getElementById('historyApplicants').textContent = history.applicantCount.toString();

                document.getElementById('historyResult').style.display = 'block';

            } catch (error) {
                console.error('Error viewing history:', error);
                showNotification('Failed to load history: ' + error.message, 'error');
            } finally {
                const btn = document.getElementById('viewHistoryBtn');
                btn.innerHTML = 'View History';
                btn.disabled = false;
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                location.reload();
            });

            window.ethereum.on('chainChanged', function (chainId) {
                location.reload();
            });
        }

        // Auto-refresh data every 30 seconds
        setInterval(async () => {
            if (contract) {
                await updateAssessmentInfo();
                await updateBusinessHours();
            }
        }, 30000);
    </script>
</body>
</html>
